{"version":3,"sources":["../../../src/contexts/Security/Security.tsx"],"names":["React","useReducer","useEffect","useCallback","useMemo","useApolloClient","localStorage","observe","getPlugins","useHandler","GET_CURRENT_USER","ID_TOKEN_LOGIN","setIdentity","SecurityContext","createContext","addPlugin","DEFAULT_AUTH_TOKEN","SecurityConsumer","children","security","cloneElement","SecurityProvider","props","auth","pop","Error","AUTH_TOKEN","client","prev","next","user","firstLoad","loading","checkingUser","state","setState","getToken","get","loginUsingIdToken","idToken","mutate","mutation","variables","res","error","data","token","removeToken","remove","setToken","set","getUser","query","fetchPolicy","getCurrentUser","onIdToken","onUser","securityProviderHook","getIdToken","renderAuthentication","authLogout","logout","checkUser","value","refreshUser","loader","allowAnonymous","defaultProps"],"mappings":"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","sourcesContent":["import React, { useReducer, useEffect, useCallback, useMemo, ReactElement } from \"react\";\nimport { useApolloClient } from \"react-apollo\";\nimport localStorage from \"store\";\nimport observe from \"store/plugins/observe\";\nimport { getPlugins } from \"@webiny/plugins\";\nimport { useHandler } from \"@webiny/app/hooks/useHandler\";\nimport { SecurityAuthenticationProviderPlugin } from \"@webiny/app-security/types\";\nimport { GET_CURRENT_USER, ID_TOKEN_LOGIN } from \"../../components/graphql\";\nimport { setIdentity } from \"../../identity\";\n\nexport const SecurityContext = React.createContext(null);\n\nlocalStorage.addPlugin(observe);\n\nexport const DEFAULT_AUTH_TOKEN = \"webiny-token\";\n\ntype Props = {\n    loader?: ReactElement;\n    allowAnonymous?: Boolean;\n    AUTH_TOKEN?: String;\n    getUser?: () => Promise<{ [key: string]: any }>;\n    onUser?: (user: { [key: string]: any }) => void;\n    children?: React.ReactNode;\n};\n\nexport const SecurityConsumer = ({ children }) => (\n    <SecurityContext.Consumer>\n        {security => React.cloneElement(children, { security })}\n    </SecurityContext.Consumer>\n);\n\nexport type SecurityContextValue = {\n    user: { [key: string]: any };\n    logout(): Promise<void>;\n    renderAuthentication(params?: { viewProps: {} }): React.ReactElement;\n    refreshUser(): Promise<void>;\n};\n\nexport const SecurityProvider = (props: Props) => {\n    const auth = getPlugins<SecurityAuthenticationProviderPlugin>(\n        \"security-authentication-provider\"\n    ).pop();\n\n    if (!auth) {\n        throw Error(\n            `You must register a \"security-authentication-provider\" plugin to use Security provider!`\n        );\n    }\n\n    const AUTH_TOKEN = props.AUTH_TOKEN || DEFAULT_AUTH_TOKEN;\n    const client = useApolloClient();\n\n    const [state, setState] = useReducer((prev, next) => ({ ...prev, ...next }), {\n        user: null,\n        firstLoad: true,\n        loading: false,\n        checkingUser: false\n    });\n\n    const getToken = useCallback(() => {\n        return localStorage.get(AUTH_TOKEN);\n    }, []);\n\n    const loginUsingIdToken = async (idToken: string) => {\n        const res: any = await client.mutate({\n            mutation: ID_TOKEN_LOGIN,\n            variables: { idToken }\n        });\n\n        if (!res.error) {\n            return res.data.security.loginUsingIdToken.data;\n        }\n\n        return { user: null, token: null };\n    };\n\n    const removeToken = useCallback(() => {\n        localStorage.remove(AUTH_TOKEN);\n    }, []);\n\n    const setToken = useCallback((token: string) => {\n        return localStorage.set(AUTH_TOKEN, token);\n    }, []);\n\n    const getUser = useHandler(props, ({ getUser }) => async () => {\n        setState({ loading: true });\n\n        if (getUser) {\n            const user = await getUser();\n            setState({ loading: false });\n            return user;\n        }\n\n        // Get user using default authentication query\n        const { data } = await client.query({ query: GET_CURRENT_USER, fetchPolicy: \"no-cache\" });\n        setState({ loading: false });\n        return data.security.getCurrentUser.data;\n    });\n\n    /**\n     * Should be called only by authentication plugin when it obtains\n     * an `idToken` from the authentication provider.\n     */\n    const onIdToken = useHandler(null, () => async idToken => {\n        setState({ checkingUser: true });\n        const { token, user } = await loginUsingIdToken(idToken);\n        setIdentity(user);\n        setToken(token);\n        setState({ user, checkingUser: false });\n        props.onUser && props.onUser(user);\n    });\n\n    // Run authentication plugin hook\n    const { getIdToken, renderAuthentication, logout: authLogout } = auth.securityProviderHook({\n        onIdToken\n    });\n\n    const logout = useCallback(async () => {\n        await authLogout();\n        localStorage.remove(AUTH_TOKEN);\n    }, []);\n\n    /**\n     * Check if user is logged-in and update state accordingly.\n     */\n    const checkUser = useHandler(null, () => async () => {\n        const idToken = await getIdToken();\n\n        if (!idToken) {\n            removeToken();\n            setState({ checkingUser: false, user: null });\n            return;\n        }\n\n        // If AUTH_TOKEN is not present -> login using idToken provided by authentication plugin\n        if (!getToken()) {\n            const { token, user } = await loginUsingIdToken(idToken);\n\n            if (token) {\n                setIdentity(user);\n                setToken(token);\n                setState({ user, checkingUser: false });\n            }\n\n            return;\n        }\n\n        // Try loading user data using Webiny token\n        setState({ checkingUser: true });\n        const user = await getUser();\n        setState({ checkingUser: false });\n\n        if (user) {\n            setIdentity(user);\n            setState({ user });\n            props.onUser && props.onUser(user);\n        } else {\n            removeToken();\n            await checkUser();\n        }\n    });\n\n    const value: SecurityContextValue = useMemo(\n        () => ({\n            user: state.user,\n            logout,\n            renderAuthentication,\n            refreshUser: async () => {\n                const user = await getUser();\n                if (user) {\n                    setIdentity(user);\n                    setState({ user });\n                } else {\n                    removeToken();\n                    await checkUser();\n                }\n            }\n        }),\n        [state.user]\n    );\n\n    useEffect(() => {\n        localStorage.observe(AUTH_TOKEN, async (token: any) => {\n            if (!token) {\n                setIdentity(null);\n                return setState({ user: null });\n            }\n            const user = await getUser();\n            setIdentity(user);\n            setState({ user, firstLoad: false });\n        });\n\n        checkUser();\n    }, []);\n\n    if (state.checkingUser) {\n        return props.loader || null;\n    }\n\n    if (!state.user && !props.allowAnonymous) {\n        return renderAuthentication();\n    }\n\n    return <SecurityContext.Provider value={value}>{props.children}</SecurityContext.Provider>;\n};\n\nSecurityProvider.defaultProps = {\n    allowAnonymous: false\n};\n"],"file":"Security.js"}