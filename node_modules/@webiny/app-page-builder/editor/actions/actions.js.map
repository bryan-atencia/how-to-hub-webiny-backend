{"version":3,"sources":["../../../src/editor/actions/actions.ts"],"names":["invariant","dotProp","gql","createAction","addMiddleware","addReducer","addHigherOrderReducer","getPlugin","getPlugins","getPage","getElementWithChildren","getParentElementWithChildren","updateChildPaths","undoable","DRAG_START","DRAG_END","ELEMENT_CREATED","ELEMENT_DROPPED","TOGGLE_PLUGIN","DEACTIVATE_PLUGIN","HIGHLIGHT_ELEMENT","ACTIVATE_ELEMENT","DEACTIVATE_ELEMENT","UPDATE_ELEMENT","DELETE_ELEMENT","FLATTEN_ELEMENTS","SETUP_EDITOR","UPDATE_REVISION","SAVING_REVISION","START_SAVING","FINISH_SAVING","horStatePath","state","action","statePath","reducer","relativeStatePath","replace","relativeStateSlice","get","newState","set","initTypes","ignoreInitialState","filter","payload","history","togglePlugin","name","params","closeOtherInGroup","plugin","typePlugins","type","Array","isArray","alreadyActive","findIndex","pl","delete","push","deactivatePlugin","highlightElement","log","element","activateElement","deactivateElement","dragStart","dragEnd","elementCreated","updateElement","path","slice","merge","elements","deleteElement","store","next","dispatch","getState","parent","id","index","el","plugins","find","elementType","onChildDeleted","child","dropElement","target","onReceived","source","position","updateRevision","onFinish","meta","saveRevision","flattenContent","els","map","result","page","content","lastSavedRevision","dataChanged","revision","other","lastContent","lastOther","debouncedSave","locked","cancel","startSaving","progress","finishSaving","data","present","category","client","mutate","mutation","variables","then","catch","err","console"],"mappings":"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","sourcesContent":["import invariant from \"invariant\";\nimport dotProp from \"dot-prop-immutable\";\nimport gql from \"graphql-tag\";\nimport { isEqual, pick, debounce, cloneDeep, merge as _merge } from \"lodash\";\nimport {\n    createAction,\n    addMiddleware,\n    addReducer,\n    addHigherOrderReducer\n} from \"@webiny/app-page-builder/editor/redux\";\nimport { getPlugin, getPlugins } from \"@webiny/plugins\";\nimport {\n    getPage,\n    getElementWithChildren,\n    getParentElementWithChildren\n} from \"@webiny/app-page-builder/editor/selectors\";\nimport { updateChildPaths } from \"@webiny/app-page-builder/editor/utils\";\nimport undoable from \"./history\";\nimport { Action, PbElement, PbEditorPageElementPlugin } from \"@webiny/app-page-builder/types\";\n\nexport const DRAG_START = `Drag start`;\nexport const DRAG_END = `Drag end`;\nexport const ELEMENT_CREATED = `Element created`;\nexport const ELEMENT_DROPPED = `Element dropped`;\nexport const TOGGLE_PLUGIN = `Toggle plugin`;\nexport const DEACTIVATE_PLUGIN = `Deactivate plugin`;\nexport const HIGHLIGHT_ELEMENT = `Highlight element`;\nexport const ACTIVATE_ELEMENT = `Activate element`;\nexport const DEACTIVATE_ELEMENT = `Deactivate element`;\nexport const UPDATE_ELEMENT = `Update element`;\nexport const DELETE_ELEMENT = `Delete element`;\nexport const FLATTEN_ELEMENTS = `Flatten elements`;\nexport const SETUP_EDITOR = `Setup editor`;\nexport const UPDATE_REVISION = `Update revision`;\nexport const SAVING_REVISION = `Save revision`;\nexport const START_SAVING = `Started saving`;\nexport const FINISH_SAVING = `Finished saving`;\n\n/***************** HISTORY REDUCER *****************/\nconst horStatePath = \"page.content\";\naddHigherOrderReducer(\n    [\n        UPDATE_ELEMENT,\n        DELETE_ELEMENT,\n        ELEMENT_DROPPED,\n        SETUP_EDITOR,\n        \"@@redux-undo/UNDO\",\n        \"@@redux-undo/REDO\",\n        \"@@redux-undo/INIT\"\n    ],\n    horStatePath,\n    () => {\n        return undoable(\n            (state = [], action, { statePath, reducer }) => {\n                // Get original reducer state path\n                const relativeStatePath =\n                    statePath !== horStatePath ? statePath.replace(horStatePath + \".\", \"\") : null;\n                const relativeStateSlice = relativeStatePath\n                    ? dotProp.get(state, relativeStatePath)\n                    : state;\n                // Execute original reducer\n                const newState = reducer(relativeStateSlice, action);\n                // Assign new data to HOR state\n                return relativeStatePath\n                    ? dotProp.set(state, relativeStatePath, newState)\n                    : newState;\n            },\n            {\n                initTypes: [\"@@redux-undo/INIT\"],\n                ignoreInitialState: true,\n                filter: action => {\n                    if (action.payload && action.payload.history === false) {\n                        return false;\n                    }\n\n                    return true;\n                }\n            }\n        );\n    }\n);\n\naddReducer(\n    [\"@@redux-undo/UNDO\", \"@@redux-undo/REDO\", \"@@redux-undo/INIT\"],\n    \"page.content\",\n    state => state\n);\n\n/***************** EDITOR ACTIONS *****************/\naddReducer([SETUP_EDITOR], null, (state, action) => {\n    return { ...state, ...action.payload };\n});\n\nexport const togglePlugin = createAction(TOGGLE_PLUGIN);\naddReducer([TOGGLE_PLUGIN], \"ui.plugins\", (state, action) => {\n    const { name, params, closeOtherInGroup = false } = action.payload;\n\n    const plugin = getPlugin(name);\n\n    if (!plugin) {\n        return state;\n    }\n\n    let typePlugins = dotProp.get(state, plugin.type);\n    if (!Array.isArray(typePlugins)) {\n        typePlugins = [];\n    }\n\n    const alreadyActive = typePlugins.findIndex(pl => pl.name === plugin.name);\n\n    if (alreadyActive > -1) {\n        typePlugins = dotProp.delete(typePlugins, alreadyActive);\n    } else {\n        if (closeOtherInGroup) {\n            typePlugins = [{ name, params }];\n        } else {\n            typePlugins.push({ name, params });\n        }\n    }\n\n    return dotProp.set(state, `${plugin.type}`, typePlugins);\n});\n\nexport const deactivatePlugin = createAction(DEACTIVATE_PLUGIN);\naddReducer([DEACTIVATE_PLUGIN], \"ui.plugins\", (state, action) => {\n    const { name } = action.payload;\n    const plugin = getPlugin(name);\n    if (!plugin) {\n        return state;\n    }\n\n    let typePlugins = dotProp.get(state, plugin.type);\n    if (!Array.isArray(typePlugins)) {\n        typePlugins = [];\n    }\n\n    const alreadyActive = typePlugins.findIndex(pl => pl.name === plugin.name);\n\n    if (alreadyActive > -1) {\n        typePlugins = dotProp.delete(typePlugins, alreadyActive);\n    }\n\n    return dotProp.set(state, `${plugin.type}`, typePlugins);\n});\n\nexport const highlightElement = createAction(HIGHLIGHT_ELEMENT, { log: false });\naddReducer([HIGHLIGHT_ELEMENT], \"ui.highlightElement\", (state, action) => {\n    return action.payload.element ? action.payload.element : null;\n});\n\nexport const activateElement = createAction(ACTIVATE_ELEMENT);\naddReducer([ACTIVATE_ELEMENT], \"ui.activeElement\", (state, action) => {\n    return action.payload.element;\n});\n\nexport const deactivateElement = createAction(DEACTIVATE_ELEMENT);\naddReducer([DEACTIVATE_ELEMENT], \"ui.activeElement\", () => null);\n\nexport const dragStart = createAction(DRAG_START);\naddReducer([DRAG_START], \"ui.dragging\", () => true);\n\nexport const dragEnd = createAction(DRAG_END);\naddReducer([DRAG_END], \"ui.dragging\", () => false);\n\nexport const elementCreated = createAction(ELEMENT_CREATED);\n\nexport type PbUpdateElement = (params: { element: PbElement }) => Action;\n\nexport const updateElement = createAction(UPDATE_ELEMENT) as PbUpdateElement;\n\naddReducer(\n    [UPDATE_ELEMENT],\n    action => {\n        const { element } = action.payload;\n        if (element.type === \"document\") {\n            return \"page.content\";\n        }\n        // .slice(2) removes `0.` from the beginning of the generated path\n        return \"page.content.\" + action.payload.element.path.replace(/\\./g, \".elements.\").slice(2);\n    },\n    (state, action) => {\n        const { element, merge = false } = action.payload;\n        if (element.elements && typeof element.elements[0] === \"string\") {\n            delete element[\"elements\"];\n        }\n        updateChildPaths(element);\n        if (!merge) {\n            return { ...state, ...element };\n        }\n        return _merge({}, state, element);\n    }\n);\n\nexport const deleteElement = createAction(DELETE_ELEMENT);\naddMiddleware([DELETE_ELEMENT], ({ store, next, action }) => {\n    next(action);\n\n    store.dispatch(deactivateElement());\n    const state = store.getState();\n\n    const { element } = action.payload;\n    let parent = getParentElementWithChildren(state, element.id);\n\n    // Remove child from parent\n    if (!parent) {\n        return;\n    }\n\n    const index = parent.elements.findIndex(el => el.id === element.id);\n    parent = dotProp.delete(parent, \"elements.\" + index);\n    store.dispatch(updateElement({ element: parent }));\n\n    // Execute `onChildDeleted` if defined\n    const plugins = getPlugins<PbEditorPageElementPlugin>(\"pb-editor-page-element\");\n    const plugin = plugins.find(pl => pl.elementType === parent.type);\n    if (!plugin) {\n        return;\n    }\n\n    if (typeof plugin.onChildDeleted === \"function\") {\n        plugin.onChildDeleted({ element: parent, child: element });\n    }\n});\n\nexport const dropElement = createAction(ELEMENT_DROPPED);\naddMiddleware([ELEMENT_DROPPED], ({ store, next, action }) => {\n    next(action);\n\n    const state = store.getState();\n    const target = getElementWithChildren(state, action.payload.target.id);\n\n    if (!target) {\n        return;\n    }\n\n    const plugins = getPlugins<PbEditorPageElementPlugin>(\"pb-editor-page-element\");\n    const plugin = plugins.find(pl => pl.elementType === target.type);\n\n    if (!plugin) {\n        return;\n    }\n\n    invariant(\n        plugin.onReceived,\n        \"To accept drops, element plugin must implement `onReceived` function\"\n    );\n\n    let { source } = action.payload;\n    if (source.path) {\n        source = getElementWithChildren(state, source.id);\n    }\n\n    if (!plugin) {\n        return;\n    }\n\n    plugin.onReceived({\n        source,\n        target,\n        position: action.payload.target.position\n    });\n});\n\nexport const updateRevision = createAction(UPDATE_REVISION);\naddMiddleware([UPDATE_REVISION], ({ store, next, action }) => {\n    next(action);\n\n    if (action.payload.history === false) {\n        return;\n    }\n\n    const { onFinish } = action.meta;\n    store.dispatch(saveRevision(null, { onFinish }));\n});\n\naddReducer([UPDATE_REVISION], \"page\", (state, action) => {\n    return { ...state, ...action.payload };\n});\n\n// Flatten page content\nconst flattenContent = el => {\n    let els = {};\n    el.elements =\n        Array.isArray(el.elements) &&\n        el.elements.map(child => {\n            els = { ...els, ...flattenContent(child) };\n            return child.id;\n        });\n\n    els[el.id] = el;\n    return els;\n};\n\naddReducer([FLATTEN_ELEMENTS], \"elements\", (state, action) => {\n    return action.payload;\n});\n\naddMiddleware(\n    [UPDATE_ELEMENT, DELETE_ELEMENT, \"@@redux-undo/UNDO\", \"@@redux-undo/REDO\", \"@@redux-undo/INIT\"],\n    ({ store, next, action }) => {\n        const result = next(action);\n\n        const state = store.getState();\n        if (state.page.content) {\n            const content = dotProp.get(state, \"page.content.present\") || null;\n            if (!content) {\n                return result;\n            }\n            const elements = flattenContent(cloneDeep(content));\n            store.dispatch({ type: FLATTEN_ELEMENTS, payload: elements, meta: { log: true } });\n        }\n\n        return result;\n    }\n);\n\n/************************* SAVE REVISION *************************/\nlet lastSavedRevision = null;\nconst dataChanged = revision => {\n    if (!lastSavedRevision) {\n        return true;\n    }\n\n    const { content, ...other } = revision;\n    const { content: lastContent, ...lastOther } = lastSavedRevision;\n\n    return !isEqual(content, lastContent) || !isEqual(other, lastOther);\n};\n\nexport const saveRevision = createAction(SAVING_REVISION);\nlet debouncedSave = null;\naddMiddleware(\n    [UPDATE_REVISION, UPDATE_ELEMENT, DELETE_ELEMENT, \"@@redux-undo/UNDO\", \"@@redux-undo/REDO\"],\n    ({ store, next, action }) => {\n        next(action);\n\n        const { onFinish } = action.meta || {};\n\n        if (action.type === UPDATE_ELEMENT && action.payload.history === false) {\n            return;\n        }\n\n        const page = getPage(store.getState());\n        if (page.locked) {\n            return;\n        }\n\n        if (debouncedSave) {\n            debouncedSave.cancel();\n        }\n\n        debouncedSave = debounce(() => store.dispatch(saveRevision(null, { onFinish })), 1000);\n        debouncedSave();\n    }\n);\n\nconst startSaving = { type: START_SAVING, payload: { progress: true } };\nconst finishSaving = { type: FINISH_SAVING, payload: { progress: false } };\n\naddReducer([START_SAVING, FINISH_SAVING], \"ui.saving\", (state, action) => {\n    return action.payload.progress;\n});\n\naddMiddleware([SAVING_REVISION], ({ store, next, action }) => {\n    next(action);\n\n    const data: any = getPage(store.getState());\n    if (data.locked) {\n        return;\n    }\n\n    // Construct page payload\n    const revision = pick(data, [\"title\", \"snippet\", \"url\", \"settings\"]) as any;\n    revision.content = data.content.present;\n    revision.category = data.category.id;\n\n    // Check if API call is necessary\n    if (!dataChanged(revision)) {\n        return;\n    }\n\n    lastSavedRevision = revision;\n\n    const updateRevision = gql`\n        mutation UpdateRevision($id: ID!, $data: PbUpdatePageInput!) {\n            pageBuilder {\n                updateRevision(id: $id, data: $data) {\n                    data {\n                        id\n                        content\n                        title\n                        published\n                        savedOn\n                    }\n                    error {\n                        code\n                        message\n                        data\n                    }\n                }\n            }\n        }\n    `;\n\n    store.dispatch(startSaving);\n\n    action.meta.client\n        .mutate({ mutation: updateRevision, variables: { id: data.id, data: revision } })\n        .then(data => {\n            store.dispatch(finishSaving);\n            action.meta.onFinish && action.meta.onFinish();\n            return data;\n        })\n        .catch(err => {\n            store.dispatch(finishSaving);\n            console.log(err); // eslint-disable-line\n        });\n});\n"],"file":"actions.js"}