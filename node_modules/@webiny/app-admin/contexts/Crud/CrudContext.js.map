{"version":3,"sources":["../../../src/contexts/Crud/CrudContext.tsx"],"names":["React","useState","useMutation","useQuery","useSnackbar","useDialog","useDataList","useRouter","getData","getError","i18n","t","ns","CrudContext","createContext","CrudProvider","children","props","showSnackbar","showDialog","location","history","list","query","variables","client","getMeta","mutationInProgress","setMutationInProgress","invalidFields","setInvalidFields","urlSearchParams","URLSearchParams","search","id","get","create","mutation","options","createMutation","update","updateMutation","delete","deleteMutation","readQuery","read","skip","onCompleted","data","error","push","toString","message","actions","item","res","title","refresh","save","formData","action","variablesHandler","operation","then","response","code","set","resetForm","form","onSubmit","loading","isValidElement"],"mappings":"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","sourcesContent":["import React, { useState } from \"react\";\nimport { useMutation, useQuery } from \"react-apollo\";\nimport { useSnackbar } from \"@webiny/app-admin/hooks/useSnackbar\";\nimport { useDialog } from \"@webiny/app-admin/hooks/useDialog\";\nimport { useDataList } from \"@webiny/app/hooks/useDataList\";\nimport { useRouter } from \"@webiny/react-router\";\nimport { getData, getError } from \"./functions\";\nimport { get } from \"lodash\";\nimport { i18n } from \"@webiny/app/i18n\";\n\ntype CrudProviderProps = {\n    create?: { [key: string]: any };\n    read?: { [key: string]: any };\n    list?: { [key: string]: any };\n    update?: { [key: string]: any };\n    delete?: { [key: string]: any };\n    children: React.ReactElement | Function;\n};\n\nconst t = i18n.ns(\"app-admin/contexts\");\n\nexport const CrudContext = React.createContext({});\n\n// TODO: complete this type.\nexport type CrudContextValue = {\n    form: any;\n    list: any;\n    actions: any;\n};\n\nexport const CrudProvider = ({ children, ...props }: CrudProviderProps) => {\n    const { showSnackbar } = useSnackbar();\n    const { showDialog } = useDialog();\n    const { location, history } = useRouter();\n\n    const list = useDataList({\n        query: get(props, \"list.query\", props.list),\n        variables: get(props, \"list.variables\"),\n        client: get(props, \"list.options.client\"),\n        // \"useDataList\" will know how to handle no-handler-provided situations.\n        getData: get(props, \"list.getData\"),\n        getMeta: get(props, \"list.getMeta\"),\n        getError: get(props, \"list.getError\")\n    });\n\n    const [mutationInProgress, setMutationInProgress] = useState(false);\n    const [invalidFields, setInvalidFields] = useState({});\n\n    const urlSearchParams = new URLSearchParams(location.search);\n    const id = urlSearchParams.get(\"id\");\n\n    const [createMutation] = useMutation(\n        props.create.mutation || props.create,\n        props.create.options || null\n    );\n    const [updateMutation] = useMutation(\n        props.update.mutation || props.update,\n        props.update.options || null\n    );\n    const [deleteMutation] = useMutation(\n        props.delete.mutation || props.delete,\n        props.delete.options || null\n    );\n\n    const readQuery = useQuery(props.read.query || props.read, {\n        ...(props.read.options || {}),\n        variables: { id },\n        skip: !id,\n        onCompleted(data) {\n            const error = get(props, \"read.getError\", getError)(data);\n            if (!error) {\n                return;\n            }\n\n            const query = new URLSearchParams(location.search);\n            query.delete(\"id\");\n            history.push({ search: query.toString() });\n            showSnackbar(error.message);\n        }\n    });\n\n    const actions = {\n        delete: async (item: any) => {\n            const res = await deleteMutation({ variables: { id: item.id } });\n            const error = get(props, \"delete.getError\", getError)(res);\n\n            if (error) {\n                const message = error.message || t`Could not delete record.`;\n                showSnackbar(message, {\n                    title: \"Something unexpected happened\"\n                });\n            } else {\n                let message = get(props, \"delete.snackbar\", t`Record deleted successfully.`);\n                if (typeof message === \"function\") {\n                    message = message(item);\n                }\n                showSnackbar(message);\n            }\n\n            if (item.id === id) {\n                const query = new URLSearchParams(location.search);\n                query.delete(\"id\");\n                history.push({ search: query.toString() });\n            }\n\n            list.refresh();\n        },\n        save: async (formData: Object) => {\n            delete formData[\"id\"];\n            const action = id ? \"update\" : \"create\";\n            setMutationInProgress(true);\n            setInvalidFields(null);\n\n            const variablesHandler = get(props[action], \"variables\");\n            const variables = variablesHandler ? variablesHandler(formData) : { data: formData };\n            const operation =\n                action === \"create\"\n                    ? createMutation({ variables })\n                    : updateMutation({ variables: { id, ...variables } });\n\n            return operation.then(response => {\n                const data = get(props[action], \"getData\", getData)(response.data);\n                const error = get(props[action], \"getError\", getError)(response.data);\n\n                if (error) {\n                    if (error.code === \"VALIDATION_FAILED_INVALID_FIELDS\") {\n                        showSnackbar(t`One or more fields are not valid!`);\n                        setInvalidFields(error.data.invalidFields);\n                    } else {\n                        const message = error.message || t`Could not save record.`;\n                        showDialog(message, {\n                            title: t`Something unexpected happened`\n                        });\n                    }\n                    setMutationInProgress(false);\n                    return;\n                }\n\n                let message = get(props[action], \"snackbar\", t`Record saved successfully.`);\n                if (typeof message === \"function\") {\n                    message = message(data);\n                }\n                showSnackbar(message);\n\n                const query = new URLSearchParams(location.search);\n                query.set(\"id\", data.id);\n                history.push({ search: query.toString() });\n\n                !id && list.refresh();\n                setMutationInProgress(false);\n            });\n        },\n        resetForm: () => {\n            const query = new URLSearchParams(location.search);\n            query.delete(\"id\");\n            history.push({ search: query.toString() });\n        }\n    };\n\n    const form = {\n        data: props.read.getData ? props.read.getData(readQuery.data) : getData(readQuery.data),\n        error: props.read.getError ? props.read.getError(readQuery.data) : getError(readQuery.data),\n        onSubmit: actions.save,\n        loading: mutationInProgress || readQuery.loading,\n        id,\n        invalidFields\n    };\n\n    if (!form.data) {\n        form.data = {};\n    }\n\n    return (\n        <CrudContext.Provider value={{ form, list, actions }}>\n            {React.isValidElement(children) ? children : children({ form, list, actions })}\n        </CrudContext.Provider>\n    );\n};\n"],"file":"CrudContext.js"}